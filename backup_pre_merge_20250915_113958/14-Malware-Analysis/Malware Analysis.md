```markdown
# Malware Analysis Cheat Sheet

**Disclaimer:** Perform analysis only in isolated, controlled environments. Malware can cause damage and persist on systems.

---

## 1. Analysis Environment Setup

### Safe Laboratory Setup
```bash
# Virtualization Software
- VMware Workstation (with isolation settings)
- VirtualBox (less secure for advanced malware)
- QEMU/KVM

# Network Isolation
- Host-only networking
- Internal virtual networks
- Removable NIC for physical isolation

# Analysis VM Setup
- Windows 10/11 (for Windows malware)
- Linux distro (for Linux malware)
- Snapshots: CLEAN, ANALYSIS, POST-INFECTION
- Tools pre-installed on desktop
```

### Essential Tools Checklist
- **Process Monitor** (Procmon)
- **Process Explorer** (Procexp)
- **Wireshark** (Network analysis)
- **Regshot** (Registry comparison)
- **API Monitor** (API calls)
- **PE-bear** / **CFF Explorer** (PE analysis)
- **HxD** (Hex editor)
- **IDA Pro** / **Ghidra** (Disassemblers)
- **x64dbg** / **OllyDbg** (Debuggers)
- **YARA** (Pattern matching)

---

## 2. Basic Static Analysis

### File Identification
```bash
# Linux commands
file malware.exe
strings malware.exe | less
strings -el malware.exe  # Unicode strings
hexdump -C malware.exe | head -50

# Check hashes
md5sum malware.exe
sha256sum malware.exe
ssdeep malware.exe

# PE file analysis
pecheck malware.exe
pedump --headers malware.exe
```

### Quick Triaging
```bash
# Check packers/obfuscators
peid malware.exe
diec malware.exe  # Detect It Easy

# Basic YARA scan
yara -r rules.yar malware.exe

# Submit to online scanners
# - VirusTotal
# - Hybrid Analysis
# - Any.run
# - Joe Sandbox
```

---

## 3. Dynamic Analysis (Behavioral)

### System Monitoring
```bash
# Process monitoring
procmon.exe  # Filter: ProcessName contains malware
procexp.exe  # Real-time process tree

# Registry monitoring
regshot.exe  # Take before/after shots

# File system monitoring
procmon.exe  # Filter: Operation is CreateFile/WriteFile
```

### Network Analysis
```bash
# Start capture first!
wireshark &  # or tcpdump

# Analyze traffic
# Filter: ip.src==MALWARE_IP or ip.dst==MALWARE_IP
# Look for: DNS queries, HTTP requests, C2 communications

# Simulate internet (fake DNS)
# Use inetsim or fakeDNS
```

### Automated Sandbox Execution
```bash
# Cuckoo Sandbox setup
python cuckoo.py
# Submit sample via web interface or API

# Other options:
# - Joe Sandbox
# - Hybrid Analysis
# - Any.run (web-based)
```

---

## 4. Advanced Static Analysis

### PE File Structure Analysis
```bash
# Examine sections
objdump -h malware.exe
readpe -S malware.exe

# Import/Export tables
objdump -p malware.exe
readpe -I malware.exe

# Resource analysis
resourcehacker malware.exe
```

### Disassembly
```bash
# Ghidra (free)
# Load malware → Auto analyze → Examine functions

# IDA Pro (commercial)
# Similar workflow, more features

# radare2 (command line)
r2 -A malware.exe
pdf @ main  # Disassemble main function
```

### String Analysis
```bash
# Extract all strings
floss malware.exe  # FLARE OLE String Solver
strings -a malware.exe > strings.txt

# Look for:
# - URLs, IP addresses
# - Registry keys
# - File paths
# - API function names
# - XOR/encoded strings
```

---

## 5. Code Analysis & Debugging

### Debugging Setup
```bash
# x64dbg (Windows)
# Set breakpoints on critical APIs:
# - CreateProcess
# - WriteFile
# - RegSetValue
# - Socket functions
# - URLDownloadToFile

# GDB (Linux)
gdb ./malware
break main
run
info registers
```

### API Monitoring
```bash
# API Monitor setup
# Filter for interesting APIs:
# - Network: socket, connect, send, recv
# - File: CreateFile, WriteFile, DeleteFile
# - Registry: RegSetValue, RegCreateKey
# - Process: CreateProcess, ShellExecute
# - System: GetSystemDirectory, GetUsername
```

### Memory Dumping
```bash
# Dump process memory
procdump.exe -ma malware.exe

# Volatility (memory forensics)
volatility -f memory.dump imageinfo
volatility -f memory.dump --profile=Win10x64 pslist
volatility -f memory.dump --profile=Win10x64 malfind
```

---

## 6. Network Analysis

### Traffic Capture & Analysis
```bash
# Capture traffic
tcpdump -i any -w malware.pcap
# or wireshark -k

# Analyze with zeek/bro
zeek -r malware.pcap

# Extract files from pcap
networkminer malware.pcap

# Check for DNS tunneling
# Look for: Long domain names, unusual record types
```

### C2 Communication Analysis
```bash
# Common C2 patterns:
# - HTTP POST requests with encrypted data
# - DNS queries for subdomains
# - ICMP tunnels
# - Social media APIs (Twitter, Discord)
# - Cloud storage (Dropbox, Google Drive)

# Decoding techniques:
# - Base64 decoding
# - XOR decryption
# - RC4 decryption
# - Custom algorithms
```

---

## 7. YARA Rules & Signatures

### Basic YARA Rule Creation
```yara
rule Malware_Family {
    meta:
        description = "Detects specific malware family"
        author = "Analyst Name"
        date = "2024-01-20"
    
    strings:
        $a = "malicious_string" nocase
        $b = { 48 89 5C 24 08 48 89 74 24 10 }  // Hex pattern
        $c = "C:\\Windows\\Temp\\badfile.exe" wide
    
    condition:
        any of them
}
```

### Advanced YARA Features
```yara
rule Packed_Executable {
    meta:
        description = "Detects packed executables"
    
    condition:
        // High entropy and low number of imports
        pe.entry_point == 0 and
        math.entropy(0, filesize) > 7 and
        pe.imports("kernel32.dll") < 5
}

rule Network_Indicator {
    strings:
        $a = "malicious-domain.com"
    
    condition:
        $a and filesize < 500KB
}
```

---

## 8. Reporting & Documentation

### Analysis Report Template
```markdown
# Malware Analysis Report

## Executive Summary
- Malware type: Trojan/Ransomware/Backdoor
- Impact level: High/Medium/Low
- Primary functionality

## Technical Details
- MD5/SHA256 hashes
- File type/size
- Packer/obfuscation used

## Behavioral Analysis
- Files created/modified
- Registry changes
- Network activity
- Process tree

## Indicators of Compromise (IOCs)
- File hashes
- IP addresses
- Domains URLs
- Registry keys

## Mitigation Recommendations
- Detection rules (YARA/Snort/Sigma)
- Removal steps
- Prevention measures
```

### IOC Extraction
```bash
# Extract IPs/domains from strings
grep -Eo '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' strings.txt
grep -Eo '[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' strings.txt

# Create YARA rules from findings
python ioc2yara.py extracted_iocs.txt
```

---

## 9. Safety & Operational Security

### Lab Isolation Procedures
```bash
# Network isolation
iptables -A INPUT -i virbr0 -j DROP
iptables -A OUTPUT -o virbr0 -j DROP

# VM isolation settings
# - Disable shared folders
# - Disable drag-and-drop
# - Disable clipboard sharing
```

### Evidence Preservation
```bash
# Take snapshots at stages:
1. CLEAN_SYSTEM
2. PRE_EXECUTION
3. POST_EXECUTION
4. MEMORY_DUMP

# Document everything
- Screenshots
- Log files
- Network captures
- Registry exports
```

### Decontamination
```bash
# Complete VM rollback
# or

# Manual cleaning (if needed)
# - Kill malicious processes
# - Remove files
# - Reverse registry changes
# - Clear DNS cache
```

---

## 🔍 Quick Analysis Workflow

1.  **Setup** → Isolated VM, tools ready, network monitoring
2.  **Static Analysis** → Hashes, strings, PE structure, packer detection
3.  **Dynamic Analysis** → Run in monitored environment, observe behavior
4.  **Code Analysis** → Debugging, disassembly, understand functionality
5.  **Network Analysis** → Capture and analyze communications
6.  **Documentation** → Create report with IOCs and recommendations
7.  **Cleanup** → Restore clean snapshot

**Remember:** Always assume malware is more sophisticated than it appears!
```