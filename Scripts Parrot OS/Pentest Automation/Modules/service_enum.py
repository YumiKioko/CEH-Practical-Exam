import subprocess
import re

def run(target, nmap_output_file, output_file):
    print(f"üõ†Ô∏è [Enumera√ß√£o de Servi√ßos] Investigando {target}...")

    services_found = {
        "SMB": False,
        "FTP": False,
        "SSH": False,
        "RDP": False
    }

    # Ler o nmap output para detectar servi√ßos
    try:
        with open(nmap_output_file, "r") as f:
            nmap_data = f.read()

            if re.search(r"smb|netbios|445/tcp", nmap_data, re.IGNORECASE):
                services_found["SMB"] = True
            if re.search(r"ftp|21/tcp", nmap_data, re.IGNORECASE):
                services_found["FTP"] = True
            if re.search(r"ssh|22/tcp", nmap_data, re.IGNORECASE):
                services_found["SSH"] = True
            if re.search(r"rdp|3389/tcp", nmap_data, re.IGNORECASE):
                services_found["RDP"] = True

    except Exception as e:
        print(f"‚ùå Erro lendo output do Nmap: {e}")
        return

    # Iniciar enumera√ß√£o autom√°tica baseada nos servi√ßos detectados
    try:
        with open(output_file, "w") as report:
            report.write(f"Enumera√ß√£o autom√°tica para {target}\n")
            report.write("="*50 + "\n\n")

            if services_found["SMB"]:
                report.write("[+] SMB detectado. Rodando enum4linux...\n")
                subprocess.run(f"enum4linux -a {target}", shell=True, stdout=report, stderr=report)

            if services_found["FTP"]:
                report.write("\n[+] FTP detectado. Tentando login an√¥nimo...\n")
                ftp_command = f"echo 'quit' | ftp -n {target}"
                subprocess.run(ftp_command, shell=True, stdout=report, stderr=report)

            if services_found["SSH"]:
                report.write("\n[+] SSH detectado. Sugest√£o: Realizar brute-force se necess√°rio.\n")
                # Aqui s√≥ sugerimos, para n√£o fazer brute autom√°tico sem autoriza√ß√£o

            if services_found["RDP"]:
                report.write("\n[+] RDP detectado. Sugest√£o: Usar ncrack para brute-force.\n")

            if not any(services_found.values()):
                report.write("Nenhum servi√ßo interessante encontrado para enumera√ß√£o autom√°tica.\n")

        print(f"‚úÖ Enumera√ß√£o de servi√ßos finalizada e salva em {output_file}")

    except Exception as e:
        print(f"‚ùå Erro durante enumera√ß√£o: {e}")
